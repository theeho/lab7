---
title: "lab7"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(knitr)
library(broom)
library(nnet)
library(broom)
library(pROC)
library(plotROC) 
library(arm)

```

Exercise 1: 

```{r}
data <- read.csv("data.csv")
glimpse(data)
```
```{r}

data_lv <- data %>% mutate(target = as.factor(target), key = as.factor(ifelse(key == 2, "D", ifelse(key == 3, "D#", "Other"))))

glimpse(data_lv)
```


```{r}
p <- ggplot(data = data_lv, aes(x = key, fill = target)) +
  geom_bar(position = "fill") +
  labs(y = "Proportion", 
       title = "target vs key") +
  coord_flip()
p
```
Exercise 2: 
```{r}
target_m_red <- glm(target ~ acousticness + danceability + duration_ms + instrumentalness + loudness + speechiness + valence, 
              data = data_lv, family = binomial)
tidy(target_m_red, conf.int = TRUE, exponentiate = FALSE) %>% 
  kable(format = "markdown", digits = 3)
```
Exercise 3: 
```{r}
target_m_full <- glm(target ~ acousticness + danceability + duration_ms + instrumentalness + loudness + speechiness + valence + key, 
              data = data_lv, family = binomial)
```

```{r}
(dev_red <- glance(target_m_red)$deviance)
(dev_full <- glance(target_m_full)$deviance)
(test_stat <- dev_red - dev_full)
1 - pchisq(test_stat, 7)
```

There is not significant evidence to suggest that the response depends on the key variable. A p value of .1 is generally very high. But on top of that, the drop-in-deviance statistic suggests that even if the resposne depends on the key, the key will not improve the model by that much at all. Given a high p-value and low deviance statistic when comparing the model with key and the model without key, I conclude that the reduced model (without key) would be the best. approach. 


Exercise 4:

```{r}
model <- target_m_full 
tidy(model, conf.int = TRUE, exponentiate = FALSE) %>% 
  kable(format = "markdown", digits = 3)
```
The keyD# coefficent tells us how the log odds of the target = 1 will change if our track is in the key of D#

```{r}
m_aug <- augment(model, type.predict = "response", 
                      type.residuals = "deviance")

nbins <- sqrt(nrow(m_aug))
m_aug %>%
  arrange(.fitted) %>%
  summarise(mean_resid = mean(.resid), #y axis
            mean_pred = mean(.fitted))
```
```{r}
arm::binnedplot(x = m_aug$.fitted, y = m_aug$.resid,
                xlab = "Predicted Probabilities", 
                main = "Binned Residual vs. Predicted Values", 
                col.int = FALSE)
```

```{r}
arm::binnedplot(x = m_aug$instrumentalness, 
                y = m_aug$.resid, 
                col.int = FALSE,
                xlab = "instrumentalness", 
                main = "Binned Residual vs. instrumentalness")
```

```{r}
m_aug %>%
  group_by(key) %>%
  summarise(mean_resid = mean(.resid))
```
```{r}
(roc_curve <- ggplot(m_aug, 
                     aes(d = as.numeric(target) - 1, 
                         m = .fitted)) +
  geom_roc(n.cuts = 5, labelround = 3) + 
  geom_abline(intercept = 0) + 
  labs(x = "False Positive Rate (1 - Specificity)", 
       y = "True Positive Rate (Sensitivity)") )
```

